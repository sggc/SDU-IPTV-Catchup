name: Update Playlist Files

on:
  push:
    paths:
      - 'original-playlist.m3u'
    branches: [ main ]
  schedule:
    - cron: '*/15 * * * *'  # 每15分钟运行一次
  workflow_dispatch:

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史记录以便比较变化
    
    - name: Check if source file changed
      id: check_changes
      run: |
        # 检查源文件是否在最近提交中有变化
        if git diff --name-only HEAD~1 HEAD | grep -q "original-playlist.m3u"; then
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "检测到源文件变化，继续处理..."
        else
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "源文件无变化，跳过处理"
        fi
    
    - name: Setup Python for processing
      if: steps.check_changes.outputs.changes_detected == 'true'
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Process playlist files
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # 创建内联Python处理脚本
        cat > process_playlist.py << 'EOF'
        #!/usr/bin/env python3
        import re
        import sys
        
        def main():
            try:
                with open('original-playlist.m3u', 'r', encoding='utf-8') as f:
                    content = f.read()
                
                # 第一步：生成catchup版本
                catchup_content = generate_catchup_version(content)
                with open('playlist-catchup.m3u', 'w', encoding='utf-8') as f:
                    f.write(catchup_content)
                print("✓ 已生成 playlist-catchup.m3u")
                
                # 第二步：生成RTP版本
                rtp_content = generate_rtp_version(catchup_content)
                with open('playlist-rtp.m3u', 'w', encoding='utf-8') as f:
                    f.write(rtp_content)
                print("✓ 已生成 playlist-rtp.m3u")
                
            except Exception as e:
                print(f"❌ 处理失败: {e}")
                sys.exit(1)
        
        def generate_catchup_version(content):
            # 匹配catchup-source中的时间参数并进行替换
            pattern = r'(catchup-source="[^"]*?)\?tvdr=\{utc:YmdHMS\}GMT-\{utcend:YmdHMS\}GMT'
            replacement = r'\1?tvdr=${(b)yyyyMMddHHmmss}GMT-${(e)yyyyMMddHHmmss}GMT&r2h-seek-offset=-28800'
            
            processed_content = re.sub(pattern, replacement, content)
            
            # 处理可能没有?tvdr参数的情况
            pattern2 = r'(catchup-source="[^"]*?)"'
            def add_catchup_params(match):
                url = match.group(1)
                if '?tvdr=' not in url:
                    if '?' not in url:
                        return url + '?tvdr=${(b)yyyyMMddHHmmss}GMT-${(e)yyyyMMddHHmmss}GMT&r2h-seek-offset=-28800"'
                    else:
                        return url + '&tvdr=${(b)yyyyMMddHHmmss}GMT-${(e)yyyyMMddHHmmss}GMT&r2h-seek-offset=-28800"'
                return match.group(0)
            
            processed_content = re.sub(pattern2, add_catchup_params, processed_content)
            return processed_content
        
        def generate_rtp_version(content):
            # 匹配所有的rtsp://URL并进行替换
            rtsp_pattern = r'rtsp://([^"\s]+)'
            
            def replace_rtsp(match):
                rtsp_path = match.group(1)
                return f'http://192.168.100.1:5140/rtsp/{rtsp_path}'
            
            processed_content = re.sub(rtsp_pattern, replace_rtsp, content)
            return processed_content
        
        if __name__ == "__main__":
            main()
        EOF
        
        # 执行处理脚本
        python process_playlist.py
    
    - name: Check for changes in generated files
      if: steps.check_changes.outputs.changes_detected == 'true'
      id: check_generated
      run: |
        # 检查生成的文件是否有变化
        if git diff --name-only | grep -q "playlist-catchup.m3u\|playlist-rtp.m3u"; then
          echo "generated_changed=true" >> $GITHUB_OUTPUT
          echo "生成的文件有变化，准备提交..."
        else
          echo "generated_changed=false" >> $GITHUB_OUTPUT
          echo "生成的文件无变化，无需提交"
        fi
    
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes_detected == 'true' && steps.check_generated.outputs.generated_changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add playlist-catchup.m3u playlist-rtp.m3u
        git commit -m "Auto-update playlist files - $(date +'%Y-%m-%d %H:%M:%S')"
        git push